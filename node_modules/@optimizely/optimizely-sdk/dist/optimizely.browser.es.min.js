import{ConsoleLogHandler as e,getLogger as t,setLogHandler as r,setLogLevel as i,LogLevel as n,setErrorHandler as o,getErrorHandler as a}from"@optimizely/js-sdk-logging";export{setLogLevel,setLogHandler as setLogger}from"@optimizely/js-sdk-logging";import{LocalStoragePendingEventsDispatcher as s,LogTierV1EventProcessor as u}from"@optimizely/js-sdk-event-processor";import{NOTIFICATION_TYPES as l,sprintf as E,generateUUID as I,keyBy as c,objectValues as _}from"@optimizely/js-sdk-utils";import{HttpPollingDatafileManager as g}from"@optimizely/js-sdk-datafile-manager";import f from"murmurhash";
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var d=function(){return(d=Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var n in t=arguments[r])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}).apply(this,arguments)};function p(){for(var e=0,t=0,r=arguments.length;t<r;t++)e+=arguments[t].length;var i=Array(e),n=0;for(t=0;t<r;t++)for(var o=arguments[t],a=0,s=o.length;a<s;a++,n++)i[n]=o[a];return i}var N={NOTSET:0,DEBUG:1,INFO:2,WARNING:3,ERROR:4},O={CONDITION_EVALUATOR_ERROR:"%s: Error evaluating audience condition of type %s: %s",DATAFILE_AND_SDK_KEY_MISSING:"%s: You must provide at least one of sdkKey or datafile. Cannot start Optimizely",EXPERIMENT_KEY_NOT_IN_DATAFILE:"%s: Experiment key %s is not in datafile.",FEATURE_NOT_IN_DATAFILE:"%s: Feature key %s is not in datafile.",IMPROPERLY_FORMATTED_EXPERIMENT:"%s: Experiment key %s is improperly formatted.",INVALID_ATTRIBUTES:"%s: Provided attributes are in an invalid format.",INVALID_BUCKETING_ID:"%s: Unable to generate hash for bucketing ID %s: %s",INVALID_DATAFILE:"%s: Datafile is invalid - property %s: %s",INVALID_DATAFILE_MALFORMED:"%s: Datafile is invalid because it is malformed.",INVALID_CONFIG:"%s: Provided Optimizely config is in an invalid format.",INVALID_JSON:"%s: JSON object is not valid.",INVALID_ERROR_HANDLER:'%s: Provided "errorHandler" is in an invalid format.',INVALID_EVENT_DISPATCHER:'%s: Provided "eventDispatcher" is in an invalid format.',INVALID_EVENT_TAGS:"%s: Provided event tags are in an invalid format.",INVALID_EXPERIMENT_KEY:"%s: Experiment key %s is not in datafile. It is either invalid, paused, or archived.",INVALID_EXPERIMENT_ID:"%s: Experiment ID %s is not in datafile.",INVALID_GROUP_ID:"%s: Group ID %s is not in datafile.",INVALID_LOGGER:'%s: Provided "logger" is in an invalid format.',INVALID_ROLLOUT_ID:"%s: Invalid rollout ID %s attached to feature %s",INVALID_USER_ID:"%s: Provided user ID is in an invalid format.",INVALID_USER_PROFILE_SERVICE:"%s: Provided user profile service instance is in an invalid format: %s.",NO_DATAFILE_SPECIFIED:"%s: No datafile specified. Cannot start optimizely.",NO_JSON_PROVIDED:"%s: No JSON object to validate against schema.",NO_VARIATION_FOR_EXPERIMENT_KEY:"%s: No variation key %s defined in datafile for experiment %s.",UNDEFINED_ATTRIBUTE:"%s: Provided attribute: %s has an undefined value.",UNRECOGNIZED_ATTRIBUTE:"%s: Unrecognized attribute %s provided. Pruning before sending event to Optimizely.",UNABLE_TO_CAST_VALUE:"%s: Unable to cast value %s to type %s, returning null.",USER_NOT_IN_FORCED_VARIATION:"%s: User %s is not in the forced variation map. Cannot remove their forced variation.",USER_PROFILE_LOOKUP_ERROR:'%s: Error while looking up user profile for user ID "%s": %s.',USER_PROFILE_SAVE_ERROR:'%s: Error while saving user profile for user ID "%s": %s.',VARIABLE_KEY_NOT_IN_DATAFILE:'%s: Variable with key "%s" associated with feature with key "%s" is not in datafile.',VARIATION_ID_NOT_IN_DATAFILE:"%s: No variation ID %s defined in datafile for experiment %s.",VARIATION_ID_NOT_IN_DATAFILE_NO_EXPERIMENT:"%s: Variation ID %s is not in the datafile.",INVALID_INPUT_FORMAT:"%s: Provided %s is in an invalid format.",INVALID_DATAFILE_VERSION:"%s: This version of the JavaScript SDK does not support the given datafile version: %s",INVALID_VARIATION_KEY:"%s: Provided variation key is in an invalid format."},R={ACTIVATE_USER:"%s: Activating user %s in experiment %s.",DISPATCH_CONVERSION_EVENT:"%s: Dispatching conversion event to URL %s with params %s.",DISPATCH_IMPRESSION_EVENT:"%s: Dispatching impression event to URL %s with params %s.",DEPRECATED_EVENT_VALUE:"%s: Event value is deprecated in %s call.",EVENT_KEY_NOT_FOUND:"%s: Event key %s is not in datafile.",EXPERIMENT_NOT_RUNNING:"%s: Experiment %s is not running.",FEATURE_ENABLED_FOR_USER:"%s: Feature %s is enabled for user %s.",FEATURE_NOT_ENABLED_FOR_USER:"%s: Feature %s is not enabled for user %s.",FEATURE_HAS_NO_EXPERIMENTS:"%s: Feature %s is not attached to any experiments.",FAILED_TO_PARSE_VALUE:'%s: Failed to parse event value "%s" from event tags.',FAILED_TO_PARSE_REVENUE:'%s: Failed to parse revenue value "%s" from event tags.',FORCED_BUCKETING_FAILED:"%s: Variation key %s is not in datafile. Not activating user %s.",INVALID_OBJECT:"%s: Optimizely object is not valid. Failing %s.",INVALID_CLIENT_ENGINE:"%s: Invalid client engine passed: %s. Defaulting to node-sdk.",INVALID_DEFAULT_DECIDE_OPTIONS:"%s: Provided default decide options is not an array.",INVALID_DECIDE_OPTIONS:"%s: Provided decide options is not an array. Using default decide options.",INVALID_VARIATION_ID:"%s: Bucketed into an invalid variation ID. Returning null.",NOTIFICATION_LISTENER_EXCEPTION:"%s: Notification listener for (%s) threw exception: %s",NO_ROLLOUT_EXISTS:"%s: There is no rollout of feature %s.",NOT_ACTIVATING_USER:"%s: Not activating user %s for experiment %s.",NOT_TRACKING_USER:"%s: Not tracking user %s.",PARSED_REVENUE_VALUE:'%s: Parsed revenue value "%s" from event tags.',PARSED_NUMERIC_VALUE:'%s: Parsed event value "%s" from event tags.',RETURNING_STORED_VARIATION:'%s: Returning previously activated variation "%s" of experiment "%s" for user "%s" from user profile.',ROLLOUT_HAS_NO_EXPERIMENTS:"%s: Rollout of feature %s has no experiments",SAVED_VARIATION:'%s: Saved variation "%s" of experiment "%s" for user "%s".',SAVED_VARIATION_NOT_FOUND:"%s: User %s was previously bucketed into variation with ID %s for experiment %s, but no matching variation was found.",SHOULD_NOT_DISPATCH_ACTIVATE:'%s: Experiment %s is not in "Running" state. Not activating user.',SKIPPING_JSON_VALIDATION:"%s: Skipping JSON schema validation.",TRACK_EVENT:"%s: Tracking event %s for user %s.",UNRECOGNIZED_DECIDE_OPTION:"%s: Unrecognized decide option %s provided.",USER_ASSIGNED_TO_EXPERIMENT_BUCKET:"%s: Assigned bucket %s to user with bucketing ID %s.",USER_BUCKETED_INTO_EXPERIMENT_IN_GROUP:"%s: User %s is in experiment %s of group %s.",USER_BUCKETED_INTO_TARGETING_RULE:"%s: User %s bucketed into targeting rule %s.",USER_IN_FEATURE_EXPERIMENT:"%s: User %s is in variation %s of experiment %s on the feature %s.",USER_IN_ROLLOUT:"%s: User %s is in rollout of feature %s.",USER_BUCKETED_INTO_EVERYONE_TARGETING_RULE:"%s: User %s bucketed into everyone targeting rule.",USER_NOT_BUCKETED_INTO_EVERYONE_TARGETING_RULE:"%s: User %s not bucketed into everyone targeting rule due to traffic allocation.",USER_NOT_BUCKETED_INTO_EXPERIMENT_IN_GROUP:"%s: User %s is not in experiment %s of group %s.",USER_NOT_BUCKETED_INTO_ANY_EXPERIMENT_IN_GROUP:"%s: User %s is not in any experiment of group %s.",USER_NOT_BUCKETED_INTO_TARGETING_RULE:"%s User %s not bucketed into targeting rule %s due to traffic allocation. Trying everyone rule.",USER_NOT_IN_FEATURE_EXPERIMENT:"%s: User %s is not in any experiment on the feature %s.",USER_NOT_IN_ROLLOUT:"%s: User %s is not in rollout of feature %s.",USER_FORCED_IN_VARIATION:"%s: User %s is forced in variation %s.",USER_MAPPED_TO_FORCED_VARIATION:"%s: Set variation %s for experiment %s and user %s in the forced variation map.",USER_DOESNT_MEET_CONDITIONS_FOR_TARGETING_RULE:"%s: User %s does not meet conditions for targeting rule %s.",USER_MEETS_CONDITIONS_FOR_TARGETING_RULE:"%s: User %s meets conditions for targeting rule %s.",USER_HAS_VARIATION:"%s: User %s is in variation %s of experiment %s.",USER_HAS_FORCED_VARIATION:"%s: Variation %s is mapped to experiment %s and user %s in the forced variation map.",USER_HAS_NO_VARIATION:"%s: User %s is in no variation of experiment %s.",USER_HAS_NO_FORCED_VARIATION:"%s: User %s is not in the forced variation map.",USER_HAS_NO_FORCED_VARIATION_FOR_EXPERIMENT:"%s: No experiment %s mapped to user %s in the forced variation map.",USER_NOT_IN_ANY_EXPERIMENT:"%s: User %s is not in any experiment of group %s.",USER_NOT_IN_EXPERIMENT:"%s: User %s does not meet conditions to be in experiment %s.",USER_RECEIVED_DEFAULT_VARIABLE_VALUE:'%s: User "%s" is not in any variation or rollout rule. Returning default value for variable "%s" of feature flag "%s".',FEATURE_NOT_ENABLED_RETURN_DEFAULT_VARIABLE_VALUE:'%s: Feature "%s" is not enabled for user %s. Returning the default variable value "%s".',VARIABLE_NOT_USED_RETURN_DEFAULT_VARIABLE_VALUE:'%s: Variable "%s" is not used in variation "%s". Returning default value.',USER_RECEIVED_VARIABLE_VALUE:'%s: Got variable value "%s" for variable "%s" of feature flag "%s"',VALID_DATAFILE:"%s: Datafile is valid.",VALID_USER_PROFILE_SERVICE:"%s: Valid user profile service provided.",VARIATION_REMOVED_FOR_USER:"%s: Variation mapped to experiment %s has been removed for user %s.",VARIABLE_REQUESTED_WITH_WRONG_TYPE:'%s: Requested variable type "%s", but variable is of type "%s". Use correct API to retrieve value. Returning None.',VALID_BUCKETING_ID:'%s: BucketingId is valid: "%s"',BUCKETING_ID_NOT_STRING:"%s: BucketingID attribute is not a string. Defaulted to userId",EVALUATING_AUDIENCE:'%s: Starting to evaluate audience "%s" with conditions: %s.',EVALUATING_AUDIENCES_COMBINED:'%s: Evaluating audiences for %s "%s": %s.',AUDIENCE_EVALUATION_RESULT:'%s: Audience "%s" evaluated to %s.',AUDIENCE_EVALUATION_RESULT_COMBINED:"%s: Audiences for %s %s collectively evaluated to %s.",MISSING_ATTRIBUTE_VALUE:'%s: Audience condition %s evaluated to UNKNOWN because no value was passed for user attribute "%s".',UNEXPECTED_CONDITION_VALUE:"%s: Audience condition %s evaluated to UNKNOWN because the condition value is not supported.",UNEXPECTED_TYPE:'%s: Audience condition %s evaluated to UNKNOWN because a value of type "%s" was passed for user attribute "%s".',UNEXPECTED_TYPE_NULL:'%s: Audience condition %s evaluated to UNKNOWN because a null value was passed for user attribute "%s".',UNKNOWN_CONDITION_TYPE:"%s: Audience condition %s has an unknown condition type. You may need to upgrade to a newer release of the Optimizely SDK.",UNKNOWN_MATCH_TYPE:"%s: Audience condition %s uses an unknown match type. You may need to upgrade to a newer release of the Optimizely SDK.",UPDATED_OPTIMIZELY_CONFIG:"%s: Updated Optimizely config to revision %s (project id %s)",OUT_OF_BOUNDS:'%s: Audience condition %s evaluated to UNKNOWN because the number value for user attribute "%s" is not in the range [-2^53, +2^53].',UNABLE_TO_ATTACH_UNLOAD:'%s: unable to bind optimizely.close() to page unload event: "%s"'},v={BOT_FILTERING:"$opt_bot_filtering",BUCKETING_ID:"$opt_bucketing_id",STICKY_BUCKETING_KEY:"$opt_experiment_bucket_map",USER_AGENT:"$opt_user_agent"},h=["node-sdk","react-sdk","javascript-sdk"],T=l,A={AB_TEST:"ab-test",FEATURE:"feature",FEATURE_TEST:"feature-test",FEATURE_VARIABLE:"feature-variable",ALL_FEATURE_VARIABLES:"all-feature-variables",FLAG:"flag"},y={FEATURE_TEST:"feature-test",ROLLOUT:"rollout",EXPERIMENT:"experiment"},U={RULE:"rule",EXPERIMENT:"experiment"},D={BOOLEAN:"boolean",DOUBLE:"double",INTEGER:"integer",STRING:"string",JSON:"json"},L={V2:"2",V3:"3",V4:"4"},S={SDK_NOT_READY:"Optimizely SDK not configured properly yet.",FLAG_KEY_INVALID:'No flag was found for key "%s".',VARIABLE_VALUE_INVALID:'Variable value for key "%s" is invalid or wrong type.'},m=Object.freeze({__proto__:null,LOG_LEVEL:N,ERROR_MESSAGES:O,LOG_MESSAGES:R,CONTROL_ATTRIBUTES:v,JAVASCRIPT_CLIENT_ENGINE:"javascript-sdk",NODE_CLIENT_ENGINE:"node-sdk",REACT_CLIENT_ENGINE:"react-sdk",NODE_CLIENT_VERSION:"4.6.2",VALID_CLIENT_ENGINES:h,NOTIFICATION_TYPES:T,DECISION_NOTIFICATION_TYPES:A,DECISION_SOURCES:y,AUDIENCE_EVALUATION_TYPES:U,FEATURE_VARIABLE_TYPES:D,DATAFILE_VERSIONS:L,DECISION_MESSAGES:S}),V="CONFIG_VALIDATOR",C=[L.V2,L.V3,L.V4],F=function(e){if("object"==typeof e&&null!==e){var t=e,r=t.errorHandler,i=t.eventDispatcher,n=t.logger;if(r&&"function"!=typeof r.handleError)throw new Error(E(O.INVALID_ERROR_HANDLER,V));if(i&&"function"!=typeof i.dispatchEvent)throw new Error(E(O.INVALID_EVENT_DISPATCHER,V));if(n&&"function"!=typeof n.log)throw new Error(E(O.INVALID_LOGGER,V));return!0}throw new Error(E(O.INVALID_CONFIG,V))},P=function(e){if(!e)throw new Error(E(O.NO_DATAFILE_SPECIFIED,V));if("string"==typeof e)try{e=JSON.parse(e)}catch(e){throw new Error(E(O.INVALID_DATAFILE_MALFORMED,V))}if("object"==typeof e&&!Array.isArray(e)&&null!==e&&-1===C.indexOf(e.version))throw new Error(E(O.INVALID_DATAFILE_VERSION,V,e.version));return e};var M={handleError:function(){}},b=function(e){return Object.keys(e).map((function(t){return encodeURIComponent(t)+"="+encodeURIComponent(e[t])})).join("&")},B={dispatchEvent:function(e,t){var r,i=e.params,n=e.url;"POST"===e.httpVerb?((r=new XMLHttpRequest).open("POST",n,!0),r.setRequestHeader("Content-Type","application/json"),r.onreadystatechange=function(){if(4===r.readyState&&t&&"function"==typeof t)try{t({statusCode:r.status})}catch(e){}},r.send(JSON.stringify(i))):(n+="?wxhr=true",i&&(n+="&"+b(i)),(r=new XMLHttpRequest).open("GET",n,!0),r.onreadystatechange=function(){if(4===r.readyState&&t&&"function"==typeof t)try{t({statusCode:r.status})}catch(e){}},r.send())}},k=function(){function e(){}return e.prototype.log=function(){},e}();function x(t){return new e(t)}var K,G=Object.freeze({__proto__:null,NoOpLogger:k,createLogger:x,createNoOpLogger:function(){return new k}});function w(e,t,r){return{variationKey:null,enabled:!1,variables:{},ruleKey:null,flagKey:e,userContext:t,reasons:r}}!function(e){e.DISABLE_DECISION_EVENT="DISABLE_DECISION_EVENT",e.ENABLED_FLAGS_ONLY="ENABLED_FLAGS_ONLY",e.IGNORE_USER_PROFILE_SERVICE="IGNORE_USER_PROFILE_SERVICE",e.INCLUDE_REASONS="INCLUDE_REASONS",e.EXCLUDE_VARIABLES="EXCLUDE_VARIABLES"}(K||(K={}));var j=function(){function e(e){var t,r=e.optimizely,i=e.userId,n=e.attributes;this.optimizely=r,this.userId=i,this.attributes=null!==(t=d({},n))&&void 0!==t?t:{}}return e.prototype.setAttribute=function(e,t){this.attributes[e]=t},e.prototype.getUserId=function(){return this.userId},e.prototype.getAttributes=function(){return d({},this.attributes)},e.prototype.getOptimizely=function(){return this.optimizely},e.prototype.decide=function(e,t){return void 0===t&&(t=[]),this.optimizely.decide(this.cloneUserContext(),e,t)},e.prototype.decideForKeys=function(e,t){return void 0===t&&(t=[]),this.optimizely.decideForKeys(this.cloneUserContext(),e,t)},e.prototype.decideAll=function(e){return void 0===e&&(e=[]),this.optimizely.decideAll(this.cloneUserContext(),e)},e.prototype.trackEvent=function(e,t){this.optimizely.track(e,this.userId,this.attributes,t)},e.prototype.cloneUserContext=function(){return new e({optimizely:this.getOptimizely(),userId:this.getUserId(),attributes:this.getAttributes()})},e}(),Y=Math.pow(2,53);var H={assign:function(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];if(!e)return{};if("function"==typeof Object.assign)return Object.assign.apply(Object,p([e],t));for(var i=Object(e),n=0;n<t.length;n++){var o=t[n];if(null!=o)for(var a in o)Object.prototype.hasOwnProperty.call(o,a)&&(i[a]=o[a])}return i},currentTimestamp:function(){return Math.round((new Date).getTime())},isSafeInteger:function(e){return"number"==typeof e&&Math.abs(e)<=Y},keyBy:function(e,t){return e?c(e,(function(e){return e[t]})):{}},uuid:I,isNumber:function(e){return"number"==typeof e}},X="PROJECT_CONFIG";var z=function(e,t){void 0===t&&(t=null);var r,i,n=(r=e,(i=H.assign({},r)).audiences=(r.audiences||[]).map((function(e){return H.assign({},e)})),i.experiments=(r.experiments||[]).map((function(e){return H.assign({},e)})),i.featureFlags=(r.featureFlags||[]).map((function(e){return H.assign({},e)})),i.groups=(r.groups||[]).map((function(e){var t=H.assign({},e);return t.experiments=(e.experiments||[]).map((function(e){return H.assign({},e)})),t})),i.rollouts=(r.rollouts||[]).map((function(e){var t=H.assign({},e);return t.experiments=(e.experiments||[]).map((function(e){return H.assign({},e)})),t})),i);return n.__datafileStr=null===t?JSON.stringify(e):t,(n.audiences||[]).forEach((function(e){e.conditions=JSON.parse(e.conditions)})),n.audiencesById=H.keyBy(n.audiences,"id"),H.assign(n.audiencesById,H.keyBy(n.typedAudiences,"id")),n.attributeKeyMap=H.keyBy(n.attributes,"key"),n.eventKeyMap=H.keyBy(n.events,"key"),n.groupIdMap=H.keyBy(n.groups,"id"),Object.keys(n.groupIdMap||{}).forEach((function(e){(n.groupIdMap[e].experiments||[]).forEach((function(t){n.experiments.push(H.assign(t,{groupId:e}))}))})),n.rolloutIdMap=H.keyBy(n.rollouts||[],"id"),_(n.rolloutIdMap||{}).forEach((function(e){(e.experiments||[]).forEach((function(e){n.experiments.push(e),e.variationKeyMap=H.keyBy(e.variations,"key")}))})),n.experimentKeyMap=H.keyBy(n.experiments,"key"),n.experimentIdMap=H.keyBy(n.experiments,"id"),n.variationIdMap={},n.variationVariableUsageMap={},(n.experiments||[]).forEach((function(e){e.variationKeyMap=H.keyBy(e.variations,"key"),H.assign(n.variationIdMap,H.keyBy(e.variations,"id")),_(e.variationKeyMap||{}).forEach((function(e){e.variables&&(n.variationVariableUsageMap[e.id]=H.keyBy(e.variables,"id"))}))})),n.experimentFeatureMap={},n.featureKeyMap=H.keyBy(n.featureFlags||[],"key"),_(n.featureKeyMap||{}).forEach((function(e){e.variables.forEach((function(e){e.type===D.STRING&&e.subType===D.JSON&&(e.type=D.JSON,delete e.subType)})),e.variableKeyMap=H.keyBy(e.variables,"key"),(e.experimentIds||[]).forEach((function(t){n.experimentFeatureMap[t]?n.experimentFeatureMap[t].push(e.id):n.experimentFeatureMap[t]=[e.id]}))})),n},J=function(e,t){var r=e.experimentIdMap[t];if(!r)throw new Error(E(O.INVALID_EXPERIMENT_ID,X,t));return r.layerId},Z=function(e,t,r){var i=e.attributeKeyMap[t],n=0===t.indexOf("$opt_");return i?(n&&r.log(N.WARNING,E("Attribute %s unexpectedly has reserved prefix %s; using attribute ID instead of reserved attribute name.",t,"$opt_")),i.id):n?t:(r.log(N.DEBUG,E(O.UNRECOGNIZED_ATTRIBUTE,X,t)),null)},W=function(e,t){var r=e.eventKeyMap[t];return r?r.id:null},$=function(e,t){var r=e.experimentKeyMap[t];if(!r)throw new Error(E(O.INVALID_EXPERIMENT_KEY,X,t));return r.status},q=function(e,t){return"Running"===$(e,t)},Q=function(e,t){return"Running"===$(e,t)},ee=function(e,t){var r=e.experimentIdMap[t];if(!r)throw new Error(E(O.INVALID_EXPERIMENT_ID,X,t));return r.audienceConditions||r.audienceIds},te=function(e,t){return e.variationIdMap.hasOwnProperty(t)?e.variationIdMap[t].key:null},re=function(e,t,r){var i=e.experimentKeyMap[t];return i.variationKeyMap.hasOwnProperty(r)?i.variationKeyMap[r].id:null},ie=function(e,t,r){var i=e.experimentIdMap[t];return i.variationKeyMap.hasOwnProperty(r)?i.variationKeyMap[r].id:null},ne=function(e,t){if(e.experimentKeyMap.hasOwnProperty(t)){var r=e.experimentKeyMap[t];if(r)return r}throw new Error(E(O.EXPERIMENT_KEY_NOT_IN_DATAFILE,X,t))},oe=function(e,t){var r=e.experimentIdMap[t];if(!r)throw new Error(E(O.INVALID_EXPERIMENT_ID,X,t));return r.trafficAllocation},ae=function(e,t,r){if(e.experimentIdMap.hasOwnProperty(t)){var i=e.experimentIdMap[t];if(i)return i}return r.log(N.ERROR,E(O.INVALID_EXPERIMENT_ID,X,t)),null},se=function(e,t,r){if(e.featureKeyMap.hasOwnProperty(t)){var i=e.featureKeyMap[t];if(i)return i}return r.log(N.ERROR,E(O.FEATURE_NOT_IN_DATAFILE,X,t)),null},ue=function(e,t,r,i){var n=e.featureKeyMap[t];if(!n)return i.log(N.ERROR,E(O.FEATURE_NOT_IN_DATAFILE,X,t)),null;var o=n.variableKeyMap[r];return o||(i.log(N.ERROR,E(O.VARIABLE_KEY_NOT_IN_DATAFILE,X,r,t)),null)},le=function(e,t,r,i){if(!t||!r)return null;if(!e.variationVariableUsageMap.hasOwnProperty(r.id))return i.log(N.ERROR,E(O.VARIATION_ID_NOT_IN_DATAFILE_NO_EXPERIMENT,X,r.id)),null;var n=e.variationVariableUsageMap[r.id][t.id];return n?n.value:null},Ee=function(e,t,r){var i;switch(t){case D.BOOLEAN:"true"!==e&&"false"!==e?(r.log(N.ERROR,E(O.UNABLE_TO_CAST_VALUE,X,e,t)),i=null):i="true"===e;break;case D.INTEGER:i=parseInt(e,10),isNaN(i)&&(r.log(N.ERROR,E(O.UNABLE_TO_CAST_VALUE,X,e,t)),i=null);break;case D.DOUBLE:i=parseFloat(e),isNaN(i)&&(r.log(N.ERROR,E(O.UNABLE_TO_CAST_VALUE,X,e,t)),i=null);break;case D.JSON:try{i=JSON.parse(e)}catch(n){r.log(N.ERROR,E(O.UNABLE_TO_CAST_VALUE,X,e,t)),i=null}break;default:i=e}return i},Ie=function(e){return e.audiencesById},ce=function(e,t){return e.eventKeyMap.hasOwnProperty(t)},_e=function(e,t){return e.experimentFeatureMap.hasOwnProperty(t)},ge=function(e){return!!e.sendFlagDecisions},fe=function(e){return e.__datafileStr},de=function(e){var t;try{t=P(e.datafile)}catch(e){return{configObj:null,error:e}}if(e.jsonSchemaValidator)try{e.jsonSchemaValidator.validate(t),e.logger.log(N.INFO,E(R.VALID_DATAFILE,X))}catch(e){return{configObj:null,error:e}}else e.logger.log(N.INFO,E(R.SKIPPING_JSON_VALIDATION,X));var r=[t];return"string"==typeof e.datafile&&r.push(e.datafile),{configObj:z.apply(void 0,r),error:null}},pe=function(){function e(t,r){this.experimentsMap=e.getExperimentsMap(t),this.featuresMap=e.getFeaturesMap(t,this.experimentsMap),this.revision=t.revision,this.datafile=r}return e.prototype.getDatafile=function(){return this.datafile},e.getRolloutExperimentIds=function(e){return(e||[]).reduce((function(e,t){return t.experiments.forEach((function(t){e[t.id]=!0})),e}),{})},e.getExperimentsMap=function(e){var t=this,r=this.getRolloutExperimentIds(e.rollouts),i=(e.featureFlags||[]).reduce((function(e,t){return e[t.id]=t.variables,e}),{});return(e.experiments||[]).reduce((function(n,o){return r[o.id]||(n[o.key]={id:o.id,key:o.key,variationsMap:(o.variations||[]).reduce((function(r,n){return r[n.key]={id:n.id,key:n.key,variablesMap:t.getMergedVariablesMap(e,n,o.id,i)},_e(e,o.id)&&(r[n.key].featureEnabled=n.featureEnabled),r}),{})}),n}),{})},e.getMergedVariablesMap=function(e,t,r,i){var n=e.experimentFeatureMap[r],o={};if(n){var a=i[n.toString()],s=(t.variables||[]).reduce((function(e,t){return e[t.id]={id:t.id,value:t.value},e}),{});o=(a||[]).reduce((function(e,r){var i=s[r.id],n=t.featureEnabled&&i?i.value:r.defaultValue;return e[r.key]={id:r.id,key:r.key,type:r.type,value:n},e}),{})}return o},e.getFeaturesMap=function(e,t){return(e.featureFlags||[]).reduce((function(r,i){return r[i.key]={id:i.id,key:i.key,experimentsMap:(i.experimentIds||[]).reduce((function(r,i){var n=e.experimentIdMap[i].key;return r[n]=t[n],r}),{}),variablesMap:(i.variables||[]).reduce((function(e,t){return e[t.key]={id:t.id,key:t.key,type:t.type,value:t.defaultValue},e}),{})},r}),{})},e}();var Ne=t();function Oe(e,t){return e instanceof Error?e.message:t||"Unknown error"}function Re(e){try{this.__initialize(e)}catch(e){Ne.error(e),this.__updateListeners=[],this.__configObj=null,this.__optimizelyConfigObj=null,this.__readyPromise=Promise.resolve({success:!1,reason:Oe(e,"Error in initialize")})}}Re.prototype.__initialize=function(e){if(this.__updateListeners=[],this.jsonSchemaValidator=e.jsonSchemaValidator,!e.datafile&&!e.sdkKey){this.__configObj=null;var t=new Error(E(O.DATAFILE_AND_SDK_KEY_MISSING,"PROJECT_CONFIG_MANAGER"));return this.__readyPromise=Promise.resolve({success:!1,reason:Oe(t)}),void Ne.error(t)}var r;if(e.datafile?(r=this.__handleNewDatafile(e.datafile))&&(this.__configObj=null):this.__configObj=null,e.sdkKey){var i={sdkKey:e.sdkKey};this.__validateDatafileOptions(e.datafileOptions)&&H.assign(i,e.datafileOptions),this.__configObj&&(i.datafile=fe(this.__configObj)),this.datafileManager=new g(i),this.datafileManager.start(),this.__readyPromise=this.datafileManager.onReady().then(this.__onDatafileManagerReadyFulfill.bind(this),this.__onDatafileManagerReadyReject.bind(this)),this.datafileManager.on("update",this.__onDatafileManagerUpdate.bind(this))}else this.__configObj?this.__readyPromise=Promise.resolve({success:!0}):this.__readyPromise=Promise.resolve({success:!1,reason:Oe(r,"Invalid datafile")})},Re.prototype.__onDatafileManagerReadyFulfill=function(){var e=this.__handleNewDatafile(this.datafileManager.get());return e?{success:!1,reason:Oe(e)}:{success:!0}},Re.prototype.__onDatafileManagerReadyReject=function(e){return{success:!1,reason:Oe(e,"Failed to become ready")}},Re.prototype.__onDatafileManagerUpdate=function(){this.__handleNewDatafile(this.datafileManager.get())},Re.prototype.__validateDatafileOptions=function(e){return void 0===e||"object"==typeof e&&null!==e},Re.prototype.__handleNewDatafile=function(e){var t=de({datafile:e,jsonSchemaValidator:this.jsonSchemaValidator,logger:Ne}),r=t.configObj,i=t.error;i?Ne.error(i):(this.__configObj?this.__configObj.revision:"null")!==r.revision&&(this.__configObj=r,this.__optimizelyConfigObj=function(e,t){return new pe(e,t)}(this.__configObj,fe(this.__configObj)),this.__updateListeners.forEach((function(e){e(r)})));return i},Re.prototype.getConfig=function(){return this.__configObj},Re.prototype.getOptimizelyConfig=function(){return this.__optimizelyConfigObj},Re.prototype.onReady=function(){return this.__readyPromise},Re.prototype.onUpdate=function(e){return this.__updateListeners.push(e),function(){var t=this.__updateListeners.indexOf(e);t>-1&&this.__updateListeners.splice(t,1)}.bind(this)},Re.prototype.stop=function(){this.datafileManager&&this.datafileManager.stop(),this.__updateListeners=[]};var ve=function(){function e(e){var t=this;this.logger=e.logger,this.errorHandler=e.errorHandler,this.notificationListeners={},_(T).forEach((function(e){t.notificationListeners[e]=[]})),this.listenerId=1}return e.prototype.addNotificationListener=function(e,t){try{if(!(_(T).indexOf(e)>-1))return-1;this.notificationListeners[e]||(this.notificationListeners[e]=[]);var r=!1;if((this.notificationListeners[e]||[]).forEach((function(e){e.callback!==t||(r=!0)})),r)return-1;this.notificationListeners[e].push({id:this.listenerId,callback:t});var i=this.listenerId;return this.listenerId+=1,i}catch(e){return this.logger.log(N.ERROR,e.message),this.errorHandler.handleError(e),-1}},e.prototype.removeNotificationListener=function(e){var t=this;try{var r,i;if(Object.keys(this.notificationListeners).some((function(n){return(t.notificationListeners[n]||[]).every((function(t,o){return t.id!==e||(r=o,i=n,!1)})),void 0!==r&&void 0!==i})),void 0!==r&&void 0!==i)return this.notificationListeners[i].splice(r,1),!0}catch(e){this.logger.log(N.ERROR,e.message),this.errorHandler.handleError(e)}return!1},e.prototype.clearAllNotificationListeners=function(){var e=this;try{_(T).forEach((function(t){e.notificationListeners[t]=[]}))}catch(e){this.logger.log(N.ERROR,e.message),this.errorHandler.handleError(e)}},e.prototype.clearNotificationListeners=function(e){try{this.notificationListeners[e]=[]}catch(e){this.logger.log(N.ERROR,e.message),this.errorHandler.handleError(e)}},e.prototype.sendNotifications=function(e,t){var r=this;try{(this.notificationListeners[e]||[]).forEach((function(i){var n=i.callback;try{n(t)}catch(t){r.logger.log(N.ERROR,E(R.NOTIFICATION_LISTENER_EXCEPTION,"NOTIFICATION_CENTER",e,t.message))}}))}catch(e){this.logger.log(N.ERROR,e.message),this.errorHandler.handleError(e)}},e}();var he=Math.pow(2,32),Te=function(e){var t=[],r=e.experimentIdMap[e.experimentId].groupId;if(r){var i=e.groupIdMap[r];if(!i)throw new Error(E(O.INVALID_GROUP_ID,"BUCKETER",r));if("random"===i.policy){var n=Ae(i,e.bucketingId,e.userId,e.logger);if(null===n){var o=E(R.USER_NOT_IN_ANY_EXPERIMENT,"BUCKETER",e.userId,r);return e.logger.log(N.INFO,o),t.push(o),{result:null,reasons:t}}if(n!==e.experimentId){var a=E(R.USER_NOT_BUCKETED_INTO_EXPERIMENT_IN_GROUP,"BUCKETER",e.userId,e.experimentKey,r);return e.logger.log(N.INFO,a),t.push(a),{result:null,reasons:t}}var s=E(R.USER_BUCKETED_INTO_EXPERIMENT_IN_GROUP,"BUCKETER",e.userId,e.experimentKey,r);e.logger.log(N.INFO,s),t.push(s)}}var u=E("%s%s",e.bucketingId,e.experimentId),l=Ue(u),I=E(R.USER_ASSIGNED_TO_EXPERIMENT_BUCKET,"BUCKETER",l,e.userId);e.logger.log(N.DEBUG,I),t.push(I);var c=ye(l,e.trafficAllocationConfig);if(null!==c&&!e.variationIdMap[c]){if(c){var _=E(R.INVALID_VARIATION_ID,"BUCKETER");e.logger.log(N.WARNING,_),t.push(_)}return{result:null,reasons:t}}return{result:c,reasons:t}},Ae=function(e,t,r,i){var n=E("%s%s",t,e.id),o=Ue(n);i.log(N.DEBUG,E(R.USER_ASSIGNED_TO_EXPERIMENT_BUCKET,"BUCKETER",o,r));var a=e.trafficAllocation;return ye(o,a)},ye=function(e,t){for(var r=0;r<t.length;r++)if(e<t[r].endOfRange)return t[r].entityId;return null},Ue=function(e){try{var t=f.v3(e,1)/he;return Math.floor(1e4*t)}catch(t){throw new Error(E(O.INVALID_BUCKETING_ID,"BUCKETER",e,t.message))}},De=["and","or","not"];function Le(e,t){if(Array.isArray(e)){var r=e[0],i=e.slice(1);switch("string"==typeof r&&-1===De.indexOf(r)&&(r="or",i=e),r){case"and":return function(e,t){var r=!1;if(Array.isArray(e)){for(var i=0;i<e.length;i++){var n=Le(e[i],t);if(!1===n)return!1;null===n&&(r=!0)}return!r||null}return null}(i,t);case"not":return function(e,t){if(Array.isArray(e)&&e.length>0){var r=Le(e[0],t);return null===r?null:!r}return null}(i,t);default:return function(e,t){var r=!1;if(Array.isArray(e)){for(var i=0;i<e.length;i++){var n=Le(e[i],t);if(!0===n)return!0;null===n&&(r=!0)}return!!r&&null}return null}(i,t)}}return t(e)}var Se=t();function me(e){return/^\d+$/.test(e)}function Ve(e){var t=e.indexOf("-"),r=e.indexOf("+");return!(t<0)&&(r<0||t<r)}function Ce(e){var t=e.indexOf("-"),r=e.indexOf("+");return!(r<0)&&(t<0||r<t)}function Fe(e){var t=e,r="";if(function(e){return/\s/.test(e)}(e))return Se.warn(R.UNKNOWN_MATCH_TYPE,"SEMANTIC VERSION",e),null;if(Ve(e)?(t=e.substring(0,e.indexOf("-")),r=e.substring(e.indexOf("-")+1)):Ce(e)&&(t=e.substring(0,e.indexOf("+")),r=e.substring(e.indexOf("+")+1)),"string"!=typeof t||"string"!=typeof r)return null;var i=t.split(".").length-1;if(i>2)return Se.warn(R.UNKNOWN_MATCH_TYPE,"SEMANTIC VERSION",e),null;var n=t.split(".");if(n.length!=i+1)return Se.warn(R.UNKNOWN_MATCH_TYPE,"SEMANTIC VERSION",e),null;for(var o=0,a=n;o<a.length;o++){if(!me(a[o]))return Se.warn(R.UNKNOWN_MATCH_TYPE,"SEMANTIC VERSION",e),null}return r&&n.push(r),n}var Pe="CUSTOM_ATTRIBUTE_CONDITION_EVALUATOR",Me=t(),be=["exact","exists","gt","ge","lt","le","substring","semver_eq","semver_lt","semver_le","semver_gt","semver_ge"],Be={};function ke(e){return"string"==typeof e||"boolean"==typeof e||H.isNumber(e)}function xe(e,t){var r=e.value,i=typeof r,n=e.name,o=t[n],a=typeof o;return!ke(r)||H.isNumber(r)&&!H.isSafeInteger(r)?(Me.warn(R.UNEXPECTED_CONDITION_VALUE,Pe,JSON.stringify(e)),null):null===o?(Me.debug(R.UNEXPECTED_TYPE_NULL,Pe,JSON.stringify(e),n),null):ke(o)&&i===a?H.isNumber(o)&&!H.isSafeInteger(o)?(Me.warn(R.OUT_OF_BOUNDS,Pe,JSON.stringify(e),n),null):r===o:(Me.warn(R.UNEXPECTED_TYPE,Pe,JSON.stringify(e),a,n),null)}function Ke(e,t){var r=e.name,i=t[r],n=typeof i,o=e.value;return null!==o&&H.isSafeInteger(o)?null===i?(Me.debug(R.UNEXPECTED_TYPE_NULL,Pe,JSON.stringify(e),r),!1):H.isNumber(i)?!!H.isSafeInteger(i)||(Me.warn(R.OUT_OF_BOUNDS,Pe,JSON.stringify(e),r),!1):(Me.warn(R.UNEXPECTED_TYPE,Pe,JSON.stringify(e),n,r),!1):(Me.warn(R.UNEXPECTED_CONDITION_VALUE,Pe,JSON.stringify(e)),!1)}function Ge(e,t){var r=e.name,i=t[r],n=typeof i,o=e.value;return"string"!=typeof o?(Me.warn(R.UNEXPECTED_CONDITION_VALUE,Pe,JSON.stringify(e)),null):null===i?(Me.debug(R.UNEXPECTED_TYPE_NULL,Pe,JSON.stringify(e),r),null):"string"!=typeof i?(Me.warn(R.UNEXPECTED_TYPE,Pe,JSON.stringify(e),n,r),null):function(e,t){var r=Fe(t),i=Fe(e);if(!r||!i)return null;for(var n=r.length,o=0;o<i.length;o++){if(n<=o)return Ve(e)||Ce(e)?1:-1;if(me(r[o])){var a=parseInt(r[o]),s=parseInt(i[o]);if(a>s)return 1;if(a<s)return-1}else{if(r[o]<i[o])return Ve(e)&&!Ve(t)?1:-1;if(r[o]>i[o])return!Ve(e)&&Ve(t)?-1:1}}return Ve(t)&&!Ve(e)?-1:0}(o,i)}Be.exact=xe,Be.exists=function(e,t){var r=t[e.name];return null!=r},Be.gt=function(e,t){var r=t[e.name],i=e.value;if(!Ke(e,t)||null===i)return null;return r>i},Be.ge=function(e,t){var r=t[e.name],i=e.value;if(!Ke(e,t)||null===i)return null;return r>=i},Be.lt=function(e,t){var r=t[e.name],i=e.value;if(!Ke(e,t)||null===i)return null;return r<i},Be.le=function(e,t){var r=t[e.name],i=e.value;if(!Ke(e,t)||null===i)return null;return r<=i},Be.substring=function(e,t){var r=e.name,i=t[e.name],n=typeof i,o=e.value;if("string"!=typeof o)return Me.warn(R.UNEXPECTED_CONDITION_VALUE,Pe,JSON.stringify(e)),null;if(null===i)return Me.debug(R.UNEXPECTED_TYPE_NULL,Pe,JSON.stringify(e),r),null;if("string"!=typeof i)return Me.warn(R.UNEXPECTED_TYPE,Pe,JSON.stringify(e),n,r),null;return-1!==i.indexOf(o)},Be.semver_eq=function(e,t){var r=Ge(e,t);if(null===r)return null;return 0===r},Be.semver_gt=function(e,t){var r=Ge(e,t);if(null===r)return null;return r>0},Be.semver_ge=function(e,t){var r=Ge(e,t);if(null===r)return null;return r>=0},Be.semver_lt=function(e,t){var r=Ge(e,t);if(null===r)return null;return r<0},Be.semver_le=function(e,t){var r=Ge(e,t);if(null===r)return null;return r<=0};var we=Object.freeze({__proto__:null,evaluate:function(e,t){var r=e.match;if(void 0!==r&&-1===be.indexOf(r))return Me.warn(R.UNKNOWN_MATCH_TYPE,Pe,JSON.stringify(e)),null;var i=e.name;return t.hasOwnProperty(i)||"exists"==r?(r&&Be[r]||xe)(e,t):(Me.debug(R.MISSING_ATTRIBUTE_VALUE,Pe,JSON.stringify(e),i),null)}}),je=t(),Ye=function(){function e(e){this.typeToEvaluatorMap=H.assign({},e,{custom_attribute:we})}return e.prototype.evaluate=function(e,t,r){var i=this;if(void 0===r&&(r={}),!e||0===e.length)return!0;return!!Le(e,(function(e){var n=t[e];if(n){je.log(N.DEBUG,E(R.EVALUATING_AUDIENCE,"AUDIENCE_EVALUATOR",e,JSON.stringify(n.conditions)));var o=Le(n.conditions,i.evaluateConditionWithUserAttributes.bind(i,r)),a=null===o?"UNKNOWN":o.toString().toUpperCase();return je.log(N.DEBUG,E(R.AUDIENCE_EVALUATION_RESULT,"AUDIENCE_EVALUATOR",e,a)),o}return null}))},e.prototype.evaluateConditionWithUserAttributes=function(e,t){var r=this.typeToEvaluatorMap[t.type];if(!r)return je.log(N.WARNING,E(R.UNKNOWN_CONDITION_TYPE,"AUDIENCE_EVALUATOR",JSON.stringify(t))),null;try{return r.evaluate(t,e)}catch(e){je.log(N.ERROR,E(O.CONDITION_EVALUATOR_ERROR,"AUDIENCE_EVALUATOR",t.type,e.message))}return null},e}();function He(e){return"string"==typeof e&&""!==e}var Xe="DECISION_SERVICE",ze=function(){function e(e){var t;this.audienceEvaluator=(t=e.UNSTABLE_conditionEvaluators,new Ye(t)),this.forcedVariationMap={},this.logger=e.logger,this.userProfileService=e.userProfileService||null}return e.prototype.getVariation=function(e,t,r,i,n){void 0===n&&(n={});var o=this.getBucketingId(r,i),a=[],s=t.key;if(!this.checkIfExperimentIsActive(e,s)){var u=E(R.EXPERIMENT_NOT_RUNNING,Xe,s);return this.logger.log(N.INFO,u),a.push(u),{result:null,reasons:a}}var l=this.getForcedVariation(e,s,r);a.push.apply(a,l.reasons);var I=l.result;if(I)return{result:I,reasons:a};var c=this.getWhitelistedVariation(t,r);a.push.apply(a,c.reasons);var _=c.result;if(_)return{result:_.key,reasons:a};var g=n[K.IGNORE_USER_PROFILE_SERVICE],f=this.resolveExperimentBucketMap(r,i);if(!g&&(_=this.getStoredVariation(e,t,r,f))){var d=E(R.RETURNING_STORED_VARIATION,Xe,_.key,s,r);return this.logger.log(N.INFO,d),a.push(d),{result:_.key,reasons:a}}var p=this.checkIfUserIsInAudience(e,t,U.EXPERIMENT,i,"");if(a.push.apply(a,p.reasons),!p.result){var O=E(R.USER_NOT_IN_EXPERIMENT,Xe,r,s);return this.logger.log(N.INFO,O),a.push(O),{result:null,reasons:a}}var v=this.buildBucketerParams(e,t,o,r),h=Te(v);a.push.apply(a,h.reasons);var T=h.result;if(T&&(_=e.variationIdMap[T]),!_){var A=E(R.USER_HAS_NO_VARIATION,Xe,r,s);return this.logger.log(N.DEBUG,A),a.push(A),{result:null,reasons:a}}var y=E(R.USER_HAS_VARIATION,Xe,r,_.key,s);return this.logger.log(N.INFO,y),a.push(y),g||this.saveUserProfile(t,_,r,f),{result:_.key,reasons:a}},e.prototype.resolveExperimentBucketMap=function(e,t){t=t||{};var r=this.getUserProfile(e)||{},i=t[v.STICKY_BUCKETING_KEY];return H.assign({},r.experiment_bucket_map,i)},e.prototype.checkIfExperimentIsActive=function(e,t){return q(e,t)},e.prototype.getWhitelistedVariation=function(e,t){var r=[];if(e.forcedVariations&&e.forcedVariations.hasOwnProperty(t)){var i=e.forcedVariations[t];if(e.variationKeyMap.hasOwnProperty(i)){var n=E(R.USER_FORCED_IN_VARIATION,Xe,t,i);return this.logger.log(N.INFO,n),r.push(n),{result:e.variationKeyMap[i],reasons:r}}var o=E(R.FORCED_BUCKETING_FAILED,Xe,i,t);return this.logger.log(N.ERROR,o),r.push(o),{result:null,reasons:r}}return{result:null,reasons:r}},e.prototype.checkIfUserIsInAudience=function(e,t,r,i,n){var o=[],a=ee(e,t.id),s=Ie(e),u=E(R.EVALUATING_AUDIENCES_COMBINED,Xe,r,n||t.key,JSON.stringify(a));this.logger.log(N.DEBUG,u),o.push(u);var l=this.audienceEvaluator.evaluate(a,s,i),I=E(R.AUDIENCE_EVALUATION_RESULT_COMBINED,Xe,r,n||t.key,l.toString().toUpperCase());return this.logger.log(N.INFO,I),o.push(I),{result:l,reasons:o}},e.prototype.buildBucketerParams=function(e,t,r,i){return{bucketingId:r,experimentId:t.id,experimentKey:t.key,experimentIdMap:e.experimentIdMap,experimentKeyMap:e.experimentKeyMap,groupIdMap:e.groupIdMap,logger:this.logger,trafficAllocationConfig:oe(e,t.id),userId:i,variationIdMap:e.variationIdMap}},e.prototype.getStoredVariation=function(e,t,r,i){if(i.hasOwnProperty(t.id)){var n=i[t.id],o=n.variation_id;if(e.variationIdMap.hasOwnProperty(o))return e.variationIdMap[n.variation_id];this.logger.log(N.INFO,E(R.SAVED_VARIATION_NOT_FOUND,Xe,r,o,t.key))}return null},e.prototype.getUserProfile=function(e){var t={user_id:e,experiment_bucket_map:{}};if(!this.userProfileService)return t;try{return this.userProfileService.lookup(e)}catch(t){this.logger.log(N.ERROR,E(O.USER_PROFILE_LOOKUP_ERROR,Xe,e,t.message))}return null},e.prototype.saveUserProfile=function(e,t,r,i){if(this.userProfileService)try{i[e.id]={variation_id:t.id},this.userProfileService.save({user_id:r,experiment_bucket_map:i}),this.logger.log(N.INFO,E(R.SAVED_VARIATION,Xe,t.key,e.key,r))}catch(e){this.logger.log(N.ERROR,E(O.USER_PROFILE_SAVE_ERROR,Xe,r,e.message))}},e.prototype.getVariationForFeature=function(e,t,r,i,n){void 0===n&&(n={});var o=[],a=this.getVariationForFeatureExperiment(e,t,r,i,n);o.push.apply(o,a.reasons);var s=a.result;if(null!==s.variation)return{result:s,reasons:o};var u=this.getVariationForRollout(e,t,r,i);o.push.apply(o,u.reasons);var l=u.result;if(l.variation){var I=E(R.USER_IN_ROLLOUT,Xe,r,t.key);return this.logger.log(N.DEBUG,I),o.push(I),{result:l,reasons:o}}var c=E(R.USER_NOT_IN_ROLLOUT,Xe,r,t.key);return this.logger.log(N.DEBUG,c),o.push(c),{result:l,reasons:o}},e.prototype.getVariationForFeatureExperiment=function(e,t,r,i,n){void 0===n&&(n={});var o,a,s=[],u=null;if(t.experimentIds.length>0)for(a=0;a<t.experimentIds.length;a++){var l=ae(e,t.experimentIds[a],this.logger);if(l)if(o=this.getVariation(e,l,r,i,n),s.push.apply(s,o.reasons),u=o.result)return{result:{experiment:l,variation:l.variationKeyMap[u],decisionSource:y.FEATURE_TEST},reasons:s}}else{var I=E(R.FEATURE_HAS_NO_EXPERIMENTS,Xe,t.key);this.logger.log(N.DEBUG,I),s.push(I)}return{result:{experiment:null,variation:null,decisionSource:y.FEATURE_TEST},reasons:s}},e.prototype.getVariationForRollout=function(e,t,r,i){var n=[];if(!t.rolloutId){var o=E(R.NO_ROLLOUT_EXISTS,Xe,t.key);return this.logger.log(N.DEBUG,o),n.push(o),{result:{experiment:null,variation:null,decisionSource:y.ROLLOUT},reasons:n}}var a=e.rolloutIdMap[t.rolloutId];if(!a){var s=E(O.INVALID_ROLLOUT_ID,Xe,t.rolloutId,t.key);return this.logger.log(N.ERROR,s),n.push(s),{result:{experiment:null,variation:null,decisionSource:y.ROLLOUT},reasons:n}}if(0===a.experiments.length){var u=E(R.ROLLOUT_HAS_NO_EXPERIMENTS,Xe,t.rolloutId);return this.logger.log(N.ERROR,u),n.push(u),{result:{experiment:null,variation:null,decisionSource:y.ROLLOUT},reasons:n}}for(var l,I,c,_,g,f,d,p=this.getBucketingId(r,i),v=a.experiments.length-1,h=0;h<v;h++){if(l=e.experimentIdMap[a.experiments[h].id],g=h+1,d=this.checkIfUserIsInAudience(e,l,U.RULE,i,g),n.push.apply(n,d.reasons),d.result){var T=E(R.USER_MEETS_CONDITIONS_FOR_TARGETING_RULE,Xe,r,g);if(this.logger.log(N.DEBUG,T),n.push(T),I=this.buildBucketerParams(e,l,p,r),f=Te(I),n.push.apply(n,f.reasons),(c=f.result)&&(_=e.variationIdMap[c]),_){var A=E(R.USER_BUCKETED_INTO_TARGETING_RULE,Xe,r,g);return this.logger.log(N.DEBUG,A),n.push(A),{result:{experiment:l,variation:_,decisionSource:y.ROLLOUT},reasons:n}}var D=E(R.USER_NOT_BUCKETED_INTO_TARGETING_RULE,Xe,r,g);this.logger.log(N.DEBUG,D),n.push(D);break}var L=E(R.USER_DOESNT_MEET_CONDITIONS_FOR_TARGETING_RULE,Xe,r,g);this.logger.log(N.DEBUG,L),n.push(L)}var S=e.experimentKeyMap[a.experiments[v].key],m=this.checkIfUserIsInAudience(e,S,U.RULE,i,"Everyone Else");if(n.push.apply(n,m.reasons),m.result){var V=E(R.USER_MEETS_CONDITIONS_FOR_TARGETING_RULE,Xe,r,"Everyone Else");if(this.logger.log(N.DEBUG,V),n.push(V),I=this.buildBucketerParams(e,S,p,r),f=Te(I),n.push.apply(n,f.reasons),(c=f.result)&&(_=e.variationIdMap[c]),_){var C=E(R.USER_BUCKETED_INTO_EVERYONE_TARGETING_RULE,Xe,r);return this.logger.log(N.DEBUG,C),n.push(C),{result:{experiment:S,variation:_,decisionSource:y.ROLLOUT},reasons:n}}var F=E(R.USER_NOT_BUCKETED_INTO_EVERYONE_TARGETING_RULE,Xe,r);this.logger.log(N.DEBUG,F),n.push(F)}return{result:{experiment:null,variation:null,decisionSource:y.ROLLOUT},reasons:n}},e.prototype.getBucketingId=function(e,t){var r=e;return null!=t&&"object"==typeof t&&t.hasOwnProperty(v.BUCKETING_ID)&&("string"==typeof t[v.BUCKETING_ID]?(r=t[v.BUCKETING_ID],this.logger.log(N.DEBUG,E(R.VALID_BUCKETING_ID,Xe,r))):this.logger.log(N.WARNING,E(R.BUCKETING_ID_NOT_STRING,Xe))),r},e.prototype.removeForcedVariation=function(e,t,r){if(!e)throw new Error(E(O.INVALID_USER_ID,Xe));if(!this.forcedVariationMap.hasOwnProperty(e))throw new Error(E(O.USER_NOT_IN_FORCED_VARIATION,Xe,e));delete this.forcedVariationMap[e][t],this.logger.log(N.DEBUG,E(R.VARIATION_REMOVED_FOR_USER,Xe,r,e))},e.prototype.setInForcedVariationMap=function(e,t,r){this.forcedVariationMap.hasOwnProperty(e)||(this.forcedVariationMap[e]={}),this.forcedVariationMap[e][t]=r,this.logger.log(N.DEBUG,E(R.USER_MAPPED_TO_FORCED_VARIATION,Xe,r,t,e))},e.prototype.getForcedVariation=function(e,t,r){var i,n=[],o=this.forcedVariationMap[r];if(!o)return this.logger.log(N.DEBUG,E(R.USER_HAS_NO_FORCED_VARIATION,Xe,r)),{result:null,reasons:n};try{var a=ne(e,t);if(!a.hasOwnProperty("id")){var s=E(O.IMPROPERLY_FORMATTED_EXPERIMENT,Xe,t);return this.logger.log(N.ERROR,s),n.push(s),{result:null,reasons:n}}i=a.id}catch(e){return this.logger.log(N.ERROR,e.message),n.push(e.message),{result:null,reasons:n}}var u=o[i];if(!u)return this.logger.log(N.DEBUG,E(R.USER_HAS_NO_FORCED_VARIATION_FOR_EXPERIMENT,Xe,t,r)),{result:null,reasons:n};var l=te(e,u);if(l){var I=E(R.USER_HAS_FORCED_VARIATION,Xe,l,t,r);this.logger.log(N.DEBUG,I),n.push(I)}else this.logger.log(N.DEBUG,E(R.USER_HAS_NO_FORCED_VARIATION_FOR_EXPERIMENT,Xe,t,r));return{result:l,reasons:n}},e.prototype.setForcedVariation=function(e,t,r,i){if(null!=i&&!He(i))return this.logger.log(N.ERROR,E(O.INVALID_VARIATION_KEY,Xe)),!1;var n;try{var o=ne(e,t);if(!o.hasOwnProperty("id"))return this.logger.log(N.ERROR,E(O.IMPROPERLY_FORMATTED_EXPERIMENT,Xe,t)),!1;n=o.id}catch(e){return this.logger.log(N.ERROR,e.message),!1}if(null==i)try{return this.removeForcedVariation(r,n,t),!0}catch(e){return this.logger.log(N.ERROR,e.message),!1}var a=re(e,t,i);if(!a)return this.logger.log(N.ERROR,E(O.NO_VARIATION_FOR_EXPERIMENT_KEY,Xe,i,t)),!1;try{return this.setInForcedVariationMap(r,n,a),!0}catch(e){return this.logger.log(N.ERROR,e.message),!1}},e}();function Je(e,t){if(e.hasOwnProperty("revenue")){var r=e.revenue,i=void 0;return"string"==typeof r?(i=parseInt(r),isNaN(i)?(t.log(N.INFO,E(R.FAILED_TO_PARSE_REVENUE,"EVENT_TAG_UTILS",r)),null):(t.log(N.INFO,E(R.PARSED_REVENUE_VALUE,"EVENT_TAG_UTILS",i)),i)):"number"==typeof r?(i=r,t.log(N.INFO,E(R.PARSED_REVENUE_VALUE,"EVENT_TAG_UTILS",i)),i):null}return null}function Ze(e,t){if(e.hasOwnProperty("value")){var r=e.value,i=void 0;return"string"==typeof r?(i=parseFloat(r),isNaN(i)?(t.log(N.INFO,E(R.FAILED_TO_PARSE_VALUE,"EVENT_TAG_UTILS",r)),null):(t.log(N.INFO,E(R.PARSED_NUMERIC_VALUE,"EVENT_TAG_UTILS",i)),i)):"number"==typeof r?(i=r,t.log(N.INFO,E(R.PARSED_NUMERIC_VALUE,"EVENT_TAG_UTILS",i)),i):null}return null}function We(e,t){return"string"==typeof e&&("string"==typeof t||"boolean"==typeof t||H.isNumber(t)&&H.isSafeInteger(t))}var $e="https://logx.optimizely.com/v1/events";function qe(e){var t=e.attributes,r=e.userId,i=e.clientEngine,n=e.clientVersion,o=e.configObj,a=e.logger,s=!!o.anonymizeIP&&o.anonymizeIP,u=o.botFiltering,l={snapshots:[],visitor_id:r,attributes:[]},E={account_id:o.accountId,project_id:o.projectId,visitors:[l],revision:o.revision,client_name:i,client_version:n,anonymize_ip:s,enrich_decisions:!0};return t&&Object.keys(t||{}).forEach((function(e){if(We(e,t[e])){var r=Z(o,e,a);r&&E.visitors[0].attributes.push({entity_id:r,key:e,type:"custom",value:t[e]})}})),"boolean"==typeof u&&E.visitors[0].attributes.push({entity_id:v.BOT_FILTERING,key:v.BOT_FILTERING,type:"custom",value:u}),E}function Qe(e){var t,r,i,n,o,a,s,u,l,E=qe(e),I=(t=e.configObj,r=e.experimentId,i=e.variationId,n=e.ruleKey,o=e.ruleType,a=e.flagKey,s=e.enabled,u=r?J(t,r):null,l=i?te(t,i):null,{decisions:[{campaign_id:u,experiment_id:r,variation_id:i,metadata:{flag_key:a,rule_key:n,rule_type:o,variation_key:l=l||"",enabled:s}}],events:[{entity_id:u,timestamp:H.currentTimestamp(),key:"campaign_activated",uuid:H.uuid()}]});return E.visitors[0].snapshots.push(I),{httpVerb:"POST",url:$e,params:E}}function et(e){var t=qe(e),r=function(e,t,r,i){var n={events:[]},o={entity_id:W(e,t),timestamp:H.currentTimestamp(),uuid:H.uuid(),key:t};if(i){var a=Je(i,r);null!==a&&(o.revenue=a);var s=Ze(i,r);null!==s&&(o.value=s),o.tags=i}return n.events.push(o),n}(e.configObj,e.eventKey,e.logger,e.eventTags);return t.visitors[0].snapshots=[r],{httpVerb:"POST",url:$e,params:t}}function tt(e){var t,r;return null!==(r=null===(t=e.experiment)||void 0===t?void 0:t.key)&&void 0!==r?r:""}function rt(e){var t,r;return null!==(r=null===(t=e.variation)||void 0===t?void 0:t.key)&&void 0!==r?r:""}function it(e){var t,r;return null!==(r=null===(t=e.variation)||void 0===t?void 0:t.featureEnabled)&&void 0!==r&&r}function nt(e){var t,r;return null!==(r=null===(t=e.experiment)||void 0===t?void 0:t.id)&&void 0!==r?r:null}var ot=t("EVENT_BUILDER");function at(e,t){var r=[];return t&&Object.keys(t||{}).forEach((function(i){if(We(i,t[i])){var n=Z(e,i,ot);n&&r.push({entityId:n,key:i,value:t[i]})}})),r}var st={createEventProcessor:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return new(u.bind.apply(u,p([void 0],e)))},LocalStoragePendingEventsDispatcher:s};var ut="USER_PROFILE_SERVICE_VALIDATOR";var lt=function(){function e(e){var t,r=this,i=e.clientEngine;-1===h.indexOf(i)&&(e.logger.log(N.INFO,E(R.INVALID_CLIENT_ENGINE,"OPTIMIZELY",i)),i="node-sdk"),this.clientEngine=i,this.clientVersion=e.clientVersion||"4.6.2",this.errorHandler=e.errorHandler,this.eventDispatcher=e.eventDispatcher,this.isOptimizelyConfigValid=e.isValidInstance,this.logger=e.logger;var n=null!==(t=e.defaultDecideOptions)&&void 0!==t?t:[];Array.isArray(n)||(this.logger.log(N.DEBUG,E(R.INVALID_DEFAULT_DECIDE_OPTIONS,"OPTIMIZELY")),n=[]);var o={};n.forEach((function(e){K[e]?o[e]=!0:r.logger.log(N.WARNING,E(R.UNRECOGNIZED_DECIDE_OPTION,"OPTIMIZELY",e))})),this.defaultDecideOptions=o,this.projectConfigManager=function(e){return new Re(e)}({datafile:e.datafile,datafileOptions:e.datafileOptions,jsonSchemaValidator:e.jsonSchemaValidator,sdkKey:e.sdkKey}),this.disposeOnUpdate=this.projectConfigManager.onUpdate((function(e){r.logger.log(N.INFO,E(R.UPDATED_OPTIMIZELY_CONFIG,"OPTIMIZELY",e.revision,e.projectId)),r.notificationCenter.sendNotifications(T.OPTIMIZELY_CONFIG_UPDATE)}));var a,s=this.projectConfigManager.onReady(),u=null;if(e.userProfileService)try{(function(e){if("object"==typeof e&&null!==e){if("function"!=typeof e.lookup)throw new Error(E(O.INVALID_USER_PROFILE_SERVICE,ut,"Missing function 'lookup'"));if("function"!=typeof e.save)throw new Error(E(O.INVALID_USER_PROFILE_SERVICE,ut,"Missing function 'save'"));return!0}throw new Error(E(O.INVALID_USER_PROFILE_SERVICE,ut))})(e.userProfileService)&&(u=e.userProfileService,this.logger.log(N.INFO,E(R.VALID_USER_PROFILE_SERVICE,"OPTIMIZELY")))}catch(e){this.logger.log(N.WARNING,e.message)}this.decisionService=(a={userProfileService:u,logger:this.logger,UNSTABLE_conditionEvaluators:e.UNSTABLE_conditionEvaluators},new ze(a)),this.notificationCenter=function(e){return new ve(e)}({logger:this.logger,errorHandler:this.errorHandler});var l={dispatcher:this.eventDispatcher,flushInterval:e.eventFlushInterval,batchSize:e.eventBatchSize,maxQueueSize:e.eventMaxQueueSize,notificationCenter:this.notificationCenter};this.eventProcessor=st.createEventProcessor(l);var I=this.eventProcessor.start();this.readyPromise=Promise.all([s,I]).then((function(e){return e[0]})),this.readyTimeouts={},this.nextReadyTimeoutId=0}return e.prototype.isValidInstance=function(){return this.isOptimizelyConfigValid&&!!this.projectConfigManager.getConfig()},e.prototype.activate=function(e,t,r){try{if(!this.isValidInstance())return this.logger.log(N.ERROR,E(R.INVALID_OBJECT,"OPTIMIZELY","activate")),null;if(!this.validateInputs({experiment_key:e,user_id:t},r))return this.notActivatingExperiment(e,t);var i=this.projectConfigManager.getConfig();if(!i)return null;try{var n=this.getVariation(e,t,r);if(null===n)return this.notActivatingExperiment(e,t);if(!Q(i,e)){var o=E(R.SHOULD_NOT_DISPATCH_ACTIVATE,"OPTIMIZELY",e);return this.logger.log(N.DEBUG,o),n}var a=ne(i,e),s={experiment:a,variation:a.variationKeyMap[n],decisionSource:y.EXPERIMENT};return this.sendImpressionEvent(s,"",t,!0,r),n}catch(r){this.logger.log(N.ERROR,r.message);var u=E(R.NOT_ACTIVATING_USER,"OPTIMIZELY",t,e);return this.logger.log(N.INFO,u),this.errorHandler.handleError(r),null}}catch(e){return this.logger.log(N.ERROR,e.message),this.errorHandler.handleError(e),null}},e.prototype.sendImpressionEvent=function(e,t,r,i,n){var o=this.projectConfigManager.getConfig();if(o){var a=function(e){var t=e.configObj,r=e.decisionObj,i=e.userId,n=e.flagKey,o=e.enabled,a=e.userAttributes,s=e.clientEngine,u=e.clientVersion,l=r.decisionSource,E=tt(r),I=nt(r),c=rt(r),_=null!==I&&""!==c?ie(t,I,c):null,g=null!==I?J(t,I):null;return{type:"impression",timestamp:H.currentTimestamp(),uuid:H.uuid(),user:{id:i,attributes:at(t,a)},context:{accountId:t.accountId,projectId:t.projectId,revision:t.revision,clientName:s,clientVersion:u,anonymizeIP:t.anonymizeIP||!1,botFiltering:t.botFiltering},layer:{id:g},experiment:{id:I,key:E},variation:{id:_,key:c},ruleKey:E,flagKey:n,ruleType:l,enabled:o}}({decisionObj:e,flagKey:t,enabled:i,userId:r,userAttributes:n,clientEngine:this.clientEngine,clientVersion:this.clientVersion,configObj:o});this.eventProcessor.process(a),this.emitNotificationCenterActivate(e,t,r,i,n)}},e.prototype.emitNotificationCenterActivate=function(e,t,r,i,n){var o=this.projectConfigManager.getConfig();if(o){var a,s=e.decisionSource,u=tt(e),l=nt(e),E=rt(e),I=null;null!==l&&""!==E&&(I=ie(o,l,E),a=o.experimentIdMap[l]);var c,_=Qe({attributes:n,clientEngine:this.clientEngine,clientVersion:this.clientVersion,configObj:o,experimentId:l,ruleKey:u,flagKey:t,ruleType:s,userId:r,enabled:i,variationId:I,logger:this.logger});a&&a.variationKeyMap&&""!==E&&(c=a.variationKeyMap[E]),this.notificationCenter.sendNotifications(T.ACTIVATE,{experiment:a,userId:r,attributes:n,variation:c,logEvent:_})}},e.prototype.track=function(e,t,r,i){try{if(!this.isValidInstance())return void this.logger.log(N.ERROR,E(R.INVALID_OBJECT,"OPTIMIZELY","track"));if(!this.validateInputs({user_id:t,event_key:e},r,i))return;var n=this.projectConfigManager.getConfig();if(!n)return;if(!ce(n,e))return this.logger.log(N.WARNING,E(R.EVENT_KEY_NOT_FOUND,"OPTIMIZELY",e)),void this.logger.log(N.WARNING,E(R.NOT_TRACKING_USER,"OPTIMIZELY",t));var o=function(e){var t=e.configObj,r=e.userId,i=e.userAttributes,n=e.clientEngine,o=e.clientVersion,a=e.eventKey,s=e.eventTags,u=W(t,a),l=s?Je(s,ot):null,E=s?Ze(s,ot):null;return{type:"conversion",timestamp:H.currentTimestamp(),uuid:H.uuid(),user:{id:r,attributes:at(t,i)},context:{accountId:t.accountId,projectId:t.projectId,revision:t.revision,clientName:n,clientVersion:o,anonymizeIP:t.anonymizeIP||!1,botFiltering:t.botFiltering},event:{id:u,key:a},revenue:l,value:E,tags:s}}({eventKey:e,eventTags:i=this.filterEmptyValues(i),userId:t,userAttributes:r,clientEngine:this.clientEngine,clientVersion:this.clientVersion,configObj:n});this.logger.log(N.INFO,E(R.TRACK_EVENT,"OPTIMIZELY",e,t)),this.eventProcessor.process(o),this.emitNotificationCenterTrack(e,t,r,i)}catch(e){this.logger.log(N.ERROR,e.message),this.errorHandler.handleError(e);var a=E(R.NOT_TRACKING_USER,"OPTIMIZELY",t);this.logger.log(N.ERROR,a)}},e.prototype.emitNotificationCenterTrack=function(e,t,r,i){try{var n=this.projectConfigManager.getConfig();if(!n)return;var o=et({attributes:r,clientEngine:this.clientEngine,clientVersion:this.clientVersion,configObj:n,eventKey:e,eventTags:i,logger:this.logger,userId:t});this.notificationCenter.sendNotifications(T.TRACK,{eventKey:e,userId:t,attributes:r,eventTags:i,logEvent:o})}catch(e){this.logger.log(N.ERROR,e.message),this.errorHandler.handleError(e)}},e.prototype.getVariation=function(e,t,r){try{if(!this.isValidInstance())return this.logger.log(N.ERROR,E(R.INVALID_OBJECT,"OPTIMIZELY","getVariation")),null;try{if(!this.validateInputs({experiment_key:e,user_id:t},r))return null;var i=this.projectConfigManager.getConfig();if(!i)return null;var n=i.experimentKeyMap[e];if(!n)return this.logger.log(N.DEBUG,E(O.INVALID_EXPERIMENT_KEY,"OPTIMIZELY",e)),null;var o=this.decisionService.getVariation(i,n,t,r).result,a=_e(i,n.id)?A.FEATURE_TEST:A.AB_TEST;return this.notificationCenter.sendNotifications(T.DECISION,{type:a,userId:t,attributes:r||{},decisionInfo:{experimentKey:e,variationKey:o}}),o}catch(e){return this.logger.log(N.ERROR,e.message),this.errorHandler.handleError(e),null}}catch(e){return this.logger.log(N.ERROR,e.message),this.errorHandler.handleError(e),null}},e.prototype.setForcedVariation=function(e,t,r){if(!this.validateInputs({experiment_key:e,user_id:t}))return!1;var i=this.projectConfigManager.getConfig();if(!i)return!1;try{return this.decisionService.setForcedVariation(i,e,t,r)}catch(e){return this.logger.log(N.ERROR,e.message),this.errorHandler.handleError(e),!1}},e.prototype.getForcedVariation=function(e,t){if(!this.validateInputs({experiment_key:e,user_id:t}))return null;var r=this.projectConfigManager.getConfig();if(!r)return null;try{return this.decisionService.getForcedVariation(r,e,t).result}catch(e){return this.logger.log(N.ERROR,e.message),this.errorHandler.handleError(e),null}},e.prototype.validateInputs=function(e,t,r){try{if(e.hasOwnProperty("user_id")){var i=e.user_id;if("string"!=typeof i||null===i||"undefined"===i)throw new Error(E(O.INVALID_INPUT_FORMAT,"OPTIMIZELY","user_id"));delete e.user_id}return Object.keys(e).forEach((function(t){if(!He(e[t]))throw new Error(E(O.INVALID_INPUT_FORMAT,"OPTIMIZELY",t))})),t&&function(e){if("object"!=typeof e||Array.isArray(e)||null===e)throw new Error(E(O.INVALID_ATTRIBUTES,"ATTRIBUTES_VALIDATOR"));Object.keys(e).forEach((function(t){if(void 0===e[t])throw new Error(E(O.UNDEFINED_ATTRIBUTE,"ATTRIBUTES_VALIDATOR",t))}))}(t),r&&function(e){if("object"!=typeof e||Array.isArray(e)||null===e)throw new Error(E(O.INVALID_EVENT_TAGS,"EVENT_TAGS_VALIDATOR"))}(r),!0}catch(e){return this.logger.log(N.ERROR,e.message),this.errorHandler.handleError(e),!1}},e.prototype.notActivatingExperiment=function(e,t){var r=E(R.NOT_ACTIVATING_USER,"OPTIMIZELY",t,e);return this.logger.log(N.INFO,r),null},e.prototype.filterEmptyValues=function(e){for(var t in e)!e.hasOwnProperty(t)||null!==e[t]&&void 0!==e[t]||delete e[t];return e},e.prototype.isFeatureEnabled=function(e,t,r){try{if(!this.isValidInstance())return this.logger.log(N.ERROR,E(R.INVALID_OBJECT,"OPTIMIZELY","isFeatureEnabled")),!1;if(!this.validateInputs({feature_key:e,user_id:t},r))return!1;var i=this.projectConfigManager.getConfig();if(!i)return!1;var n=se(i,e,this.logger);if(!n)return!1;var o={},a=this.decisionService.getVariationForFeature(i,n,t,r).result,s=a.decisionSource,u=tt(a),l=rt(a),I=it(a);s===y.FEATURE_TEST&&(o={experimentKey:u,variationKey:l}),(s===y.FEATURE_TEST||s===y.ROLLOUT&&ge(i))&&this.sendImpressionEvent(a,n.key,t,I,r),!0===I?this.logger.log(N.INFO,E(R.FEATURE_ENABLED_FOR_USER,"OPTIMIZELY",e,t)):(this.logger.log(N.INFO,E(R.FEATURE_NOT_ENABLED_FOR_USER,"OPTIMIZELY",e,t)),I=!1);var c={featureKey:e,featureEnabled:I,source:a.decisionSource,sourceInfo:o};return this.notificationCenter.sendNotifications(T.DECISION,{type:A.FEATURE,userId:t,attributes:r||{},decisionInfo:c}),I}catch(e){return this.logger.log(N.ERROR,e.message),this.errorHandler.handleError(e),!1}},e.prototype.getEnabledFeatures=function(e,t){var r=this;try{var i=[];if(!this.isValidInstance())return this.logger.log(N.ERROR,E(R.INVALID_OBJECT,"OPTIMIZELY","getEnabledFeatures")),i;if(!this.validateInputs({user_id:e}))return i;var n=this.projectConfigManager.getConfig();return n?(_(n.featureKeyMap).forEach((function(n){r.isFeatureEnabled(n.key,e,t)&&i.push(n.key)})),i):i}catch(e){return this.logger.log(N.ERROR,e.message),this.errorHandler.handleError(e),[]}},e.prototype.getFeatureVariable=function(e,t,r,i){try{return this.isValidInstance()?this.getFeatureVariableForType(e,t,null,r,i):(this.logger.log(N.ERROR,E(R.INVALID_OBJECT,"OPTIMIZELY","getFeatureVariable")),null)}catch(e){return this.logger.log(N.ERROR,e.message),this.errorHandler.handleError(e),null}},e.prototype.getFeatureVariableForType=function(e,t,r,i,n){if(!this.validateInputs({feature_key:e,variable_key:t,user_id:i},n))return null;var o=this.projectConfigManager.getConfig();if(!o)return null;var a=se(o,e,this.logger);if(!a)return null;var s=ue(o,e,t,this.logger);if(!s)return null;if(r&&s.type!==r)return this.logger.log(N.WARNING,E(R.VARIABLE_REQUESTED_WITH_WRONG_TYPE,"OPTIMIZELY",r,s.type)),null;var u=this.decisionService.getVariationForFeature(o,a,i,n).result,l=it(u),I=this.getFeatureVariableValueFromVariation(e,l,u.variation,s,i),c={};return u.decisionSource===y.FEATURE_TEST&&null!==u.experiment&&null!==u.variation&&(c={experimentKey:u.experiment.key,variationKey:u.variation.key}),this.notificationCenter.sendNotifications(T.DECISION,{type:A.FEATURE_VARIABLE,userId:i,attributes:n||{},decisionInfo:{featureKey:e,featureEnabled:l,source:u.decisionSource,variableKey:t,variableValue:I,variableType:s.type,sourceInfo:c}}),I},e.prototype.getFeatureVariableValueFromVariation=function(e,t,r,i,n){var o=this.projectConfigManager.getConfig();if(!o)return null;var a=i.defaultValue;if(null!==r){var s=le(o,i,r,this.logger);null!==s?t?(a=s,this.logger.log(N.INFO,E(R.USER_RECEIVED_VARIABLE_VALUE,"OPTIMIZELY",a,i.key,e))):this.logger.log(N.INFO,E(R.FEATURE_NOT_ENABLED_RETURN_DEFAULT_VARIABLE_VALUE,"OPTIMIZELY",e,n,a)):this.logger.log(N.INFO,E(R.VARIABLE_NOT_USED_RETURN_DEFAULT_VARIABLE_VALUE,"OPTIMIZELY",i.key,r.key))}else this.logger.log(N.INFO,E(R.USER_RECEIVED_DEFAULT_VARIABLE_VALUE,"OPTIMIZELY",n,i.key,e));return Ee(a,i.type,this.logger)},e.prototype.getFeatureVariableBoolean=function(e,t,r,i){try{return this.isValidInstance()?this.getFeatureVariableForType(e,t,D.BOOLEAN,r,i):(this.logger.log(N.ERROR,E(R.INVALID_OBJECT,"OPTIMIZELY","getFeatureVariableBoolean")),null)}catch(e){return this.logger.log(N.ERROR,e.message),this.errorHandler.handleError(e),null}},e.prototype.getFeatureVariableDouble=function(e,t,r,i){try{return this.isValidInstance()?this.getFeatureVariableForType(e,t,D.DOUBLE,r,i):(this.logger.log(N.ERROR,E(R.INVALID_OBJECT,"OPTIMIZELY","getFeatureVariableDouble")),null)}catch(e){return this.logger.log(N.ERROR,e.message),this.errorHandler.handleError(e),null}},e.prototype.getFeatureVariableInteger=function(e,t,r,i){try{return this.isValidInstance()?this.getFeatureVariableForType(e,t,D.INTEGER,r,i):(this.logger.log(N.ERROR,E(R.INVALID_OBJECT,"OPTIMIZELY","getFeatureVariableInteger")),null)}catch(e){return this.logger.log(N.ERROR,e.message),this.errorHandler.handleError(e),null}},e.prototype.getFeatureVariableString=function(e,t,r,i){try{return this.isValidInstance()?this.getFeatureVariableForType(e,t,D.STRING,r,i):(this.logger.log(N.ERROR,E(R.INVALID_OBJECT,"OPTIMIZELY","getFeatureVariableString")),null)}catch(e){return this.logger.log(N.ERROR,e.message),this.errorHandler.handleError(e),null}},e.prototype.getFeatureVariableJSON=function(e,t,r,i){try{return this.isValidInstance()?this.getFeatureVariableForType(e,t,D.JSON,r,i):(this.logger.log(N.ERROR,E(R.INVALID_OBJECT,"OPTIMIZELY","getFeatureVariableJSON")),null)}catch(e){return this.logger.log(N.ERROR,e.message),this.errorHandler.handleError(e),null}},e.prototype.getAllFeatureVariables=function(e,t,r){var i=this;try{if(!this.isValidInstance())return this.logger.log(N.ERROR,E(R.INVALID_OBJECT,"OPTIMIZELY","getAllFeatureVariables")),null;if(!this.validateInputs({feature_key:e,user_id:t},r))return null;var n=this.projectConfigManager.getConfig();if(!n)return null;var o=se(n,e,this.logger);if(!o)return null;var a=this.decisionService.getVariationForFeature(n,o,t,r).result,s=it(a),u={};o.variables.forEach((function(r){u[r.key]=i.getFeatureVariableValueFromVariation(e,s,a.variation,r,t)}));var l={};return a.decisionSource===y.FEATURE_TEST&&null!==a.experiment&&null!==a.variation&&(l={experimentKey:a.experiment.key,variationKey:a.variation.key}),this.notificationCenter.sendNotifications(T.DECISION,{type:A.ALL_FEATURE_VARIABLES,userId:t,attributes:r||{},decisionInfo:{featureKey:e,featureEnabled:s,source:a.decisionSource,variableValues:u,sourceInfo:l}}),u}catch(e){return this.logger.log(N.ERROR,e.message),this.errorHandler.handleError(e),null}},e.prototype.getOptimizelyConfig=function(){try{return this.projectConfigManager.getConfig()?this.projectConfigManager.getOptimizelyConfig():null}catch(e){return this.logger.log(N.ERROR,e.message),this.errorHandler.handleError(e),null}},e.prototype.close=function(){var e=this;try{var t=this.eventProcessor.stop();return this.disposeOnUpdate&&(this.disposeOnUpdate(),this.disposeOnUpdate=null),this.projectConfigManager&&this.projectConfigManager.stop(),Object.keys(this.readyTimeouts).forEach((function(t){var r=e.readyTimeouts[t];clearTimeout(r.readyTimeout),r.onClose()})),this.readyTimeouts={},t.then((function(){return{success:!0}}),(function(e){return{success:!1,reason:String(e)}}))}catch(e){return this.logger.log(N.ERROR,e.message),this.errorHandler.handleError(e),Promise.resolve({success:!1,reason:String(e)})}},e.prototype.onReady=function(e){var t,r,i=this;"object"==typeof e&&null!==e&&void 0!==e.timeout&&(t=e.timeout),H.isSafeInteger(t)||(t=3e4);var n=new Promise((function(e){r=e})),o=this.nextReadyTimeoutId;this.nextReadyTimeoutId++;var a=setTimeout((function(){delete i.readyTimeouts[o],r({success:!1,reason:E("onReady timeout expired after %s ms",t)})}),t);return this.readyTimeouts[o]={readyTimeout:a,onClose:function(){r({success:!1,reason:"Instance closed"})}},this.readyPromise.then((function(){clearTimeout(a),delete i.readyTimeouts[o],r({success:!0})})),Promise.race([this.readyPromise,n])},e.prototype.createUserContext=function(e,t){return this.validateInputs({user_id:e},t)?new j({optimizely:this,userId:e,attributes:t}):null},e.prototype.decide=function(e,t,r){var i,n,o,a,s=this;void 0===r&&(r=[]);var u=this.projectConfigManager.getConfig(),l=[];if(!this.isValidInstance()||!u)return l.push(S.SDK_NOT_READY),this.logger.log(N.INFO,E(R.INVALID_OBJECT,"OPTIMIZELY","decide")),w(t,e,l);var I=u.featureKeyMap[t];if(!I)return l.push(E(S.FLAG_KEY_INVALID,t)),this.logger.log(N.ERROR,E(O.FEATURE_NOT_IN_DATAFILE,"OPTIMIZELY",t)),w(t,e,l);var c=e.getUserId(),_=e.getAttributes(),g=this.getAllDecideOptions(r),f=this.decisionService.getVariationForFeature(u,I,c,_,g);l.push.apply(l,f.reasons);var d=f.result,p=d.decisionSource,v=null!==(n=null===(i=d.experiment)||void 0===i?void 0:i.key)&&void 0!==n?n:null,h=null!==(a=null===(o=d.variation)||void 0===o?void 0:o.key)&&void 0!==a?a:null,U=it(d);!0===U?this.logger.log(N.INFO,E(R.FEATURE_ENABLED_FOR_USER,"OPTIMIZELY",t,c)):this.logger.log(N.INFO,E(R.FEATURE_NOT_ENABLED_FOR_USER,"OPTIMIZELY",t,c));var D={},L=!1;g[K.EXCLUDE_VARIABLES]||I.variables.forEach((function(e){D[e.key]=s.getFeatureVariableValueFromVariation(t,U,d.variation,e,c)})),!g[K.DISABLE_DECISION_EVENT]&&(p===y.FEATURE_TEST||p===y.ROLLOUT&&ge(u))&&(this.sendImpressionEvent(d,t,c,U,_),L=!0);var m=g[K.INCLUDE_REASONS]?l:[],V={flagKey:t,enabled:U,variationKey:h,ruleKey:v,variables:D,reasons:m,decisionEventDispatched:L};return this.notificationCenter.sendNotifications(T.DECISION,{type:A.FLAG,userId:c,attributes:_,decisionInfo:V}),{variationKey:h,enabled:U,variables:D,ruleKey:v,flagKey:t,userContext:e,reasons:m}},e.prototype.getAllDecideOptions=function(e){var t=this,r=d({},this.defaultDecideOptions);return Array.isArray(e)?e.forEach((function(e){K[e]?r[e]=!0:t.logger.log(N.WARNING,E(R.UNRECOGNIZED_DECIDE_OPTION,"OPTIMIZELY",e))})):this.logger.log(N.DEBUG,E(R.INVALID_DECIDE_OPTIONS,"OPTIMIZELY")),r},e.prototype.decideForKeys=function(e,t,r){var i=this;void 0===r&&(r=[]);var n={};if(!this.isValidInstance())return this.logger.log(N.ERROR,E(R.INVALID_OBJECT,"OPTIMIZELY","decideForKeys")),n;if(0===t.length)return n;var o=this.getAllDecideOptions(r);return t.forEach((function(t){var a=i.decide(e,t,r);o[K.ENABLED_FLAGS_ONLY]&&!a.enabled||(n[t]=a)})),n},e.prototype.decideAll=function(e,t){void 0===t&&(t=[]);var r=this.projectConfigManager.getConfig();if(!this.isValidInstance()||!r)return this.logger.log(N.ERROR,E(R.INVALID_OBJECT,"OPTIMIZELY","decideAll")),{};var i=Object.keys(r.featureKeyMap);return this.decideForKeys(e,i,t)},e}(),Et=function(e){return!("number"!=typeof e||!H.isSafeInteger(e))&&e>=1},It=function(e){return!("number"!=typeof e||!H.isSafeInteger(e))&&e>0},ct=t();r(x()),i(n.INFO);var _t=!1,gt=function(e){try{e.errorHandler&&o(e.errorHandler),e.logger&&(r(e.logger),i(n.NOTSET)),void 0!==e.logLevel&&i(e.logLevel);try{F(e),e.isValidInstance=!0}catch(t){ct.error(t),e.isValidInstance=!1}var t=void 0;null==e.eventDispatcher?(t=new s({eventDispatcher:B}),_t||(t.sendPendingEvents(),_t=!0)):t=e.eventDispatcher;var u=e.eventBatchSize,l=e.eventFlushInterval;Et(e.eventBatchSize)||(ct.warn("Invalid eventBatchSize %s, defaulting to %s",e.eventBatchSize,10),u=10),It(e.eventFlushInterval)||(ct.warn("Invalid eventFlushInterval %s, defaulting to %s",e.eventFlushInterval,1e3),l=1e3);var E=d(d({clientEngine:"javascript-sdk",eventDispatcher:t},e),{eventBatchSize:u,eventFlushInterval:l,logger:ct,errorHandler:a()}),I=new lt(E);try{if("function"==typeof window.addEventListener){var c="onpagehide"in window?"pagehide":"unload";window.addEventListener(c,(function(){I.close()}),!1)}}catch(e){ct.error(R.UNABLE_TO_ATTACH_UNLOAD,"INDEX_BROWSER",e.message)}return I}catch(e){return ct.error(e),null}},ft=function(){_t=!1},dt={logging:G,errorHandler:M,eventDispatcher:B,enums:m,setLogger:r,setLogLevel:i,createInstance:gt,__internalResetRetryState:ft,OptimizelyDecideOption:K};export default dt;export{K as OptimizelyDecideOption,ft as __internalResetRetryState,gt as createInstance,m as enums,M as errorHandler,B as eventDispatcher,G as logging};
//# sourceMappingURL=optimizely.browser.es.min.js.map
